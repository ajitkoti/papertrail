---
id: 44
title: Reservoir Sampling
date: 2008-04-09T16:55:09+00:00
author: Henry
layout: post
guid: http://hnr.dnsalias.net/wordpress/?p=43
permalink: /reservoir-sampling/
categories:
  - Probability
---
Right, time to get this blog back on track. I want to talk about a useful technique that&#8217;s both highly practical and crops up in interview scenarios regularly.

Consider this problem: How can we efficiently randomly select  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />items from a set  <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />of size <img src='http://s0.wp.com/latex.php?latex=n+%3E+k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n > k' title='n > k' class='latex' />, where  <img src='http://s0.wp.com/latex.php?latex=n&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n' title='n' class='latex' />is unknown? Each member of  <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />should have an equal probability of being selected.

At first glance, this problem looks a strange mix of trivial and impossible. If we don&#8217;t know <img src='http://s0.wp.com/latex.php?latex=n&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n' title='n' class='latex' />, how can we know how to weight our selection probabilities? And, assuming  <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />is finite, how can we not know  <img src='http://s0.wp.com/latex.php?latex=n&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n' title='n' class='latex' />if we&#8217;re able &#8211; as we must be &#8211; to visit every element in <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />?

To address the second point first: we can find  <img src='http://s0.wp.com/latex.php?latex=n&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n' title='n' class='latex' />by iterating over all elements in <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />. However, this adds a pass over the entire set that might be expensive. Consider selecting rows at random from a large database table. We don&#8217;t want to bring the whole table into memory just to count the number of rows. Linked lists are another good motivating example &#8211; say we would like to select  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements from a linked list of length <img src='http://s0.wp.com/latex.php?latex=n&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='n' title='n' class='latex' />. Even if we do loop over the list to count its elements, employing the simple approach of choosing  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements at random will still be slow because random access in linked lists is not a constant time operation. In general we will take on average  <img src='http://s0.wp.com/latex.php?latex=O%28kn%29&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='O(kn)' title='O(kn)' class='latex' />time. By using the following technique, called &#8216;reservoir sampling&#8217;, we can bring this down to <img src='http://s0.wp.com/latex.php?latex=%5CTheta%28n%29&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='\Theta(n)' title='\Theta(n)' class='latex' />.

We can keep our selection of  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements updated on-line as we scan through our data structure, and we can do it very simply.

<!--more-->

Assume we make one pass over <img src='http://s0.wp.com/latex.php?latex=S&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='S' title='S' class='latex' />. As we encounter a new element, we need to make a decision about whether to include it in the sample or not. Consider the  <img src='http://s0.wp.com/latex.php?latex=i%5E%7Bth%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i^{th}' title='i^{th}' class='latex' />element. We assume that we have already selected  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements uniformly at random from the  <img src='http://s0.wp.com/latex.php?latex=i-1&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i-1' title='i-1' class='latex' />elements we have already encountered. We&#8217;ll call that set of  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />the _reservoir_. If we can update the reservoir so that it correctly contains  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements, all selected with a probability of <img src='http://s0.wp.com/latex.php?latex=k%2Fi&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/i' title='k/i' class='latex' />, then we can show that when  <img src='http://s0.wp.com/latex.php?latex=i%3Dn&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i=n' title='i=n' class='latex' />we&#8217;ll have a correct sample.

With what probability should we put the  <img src='http://s0.wp.com/latex.php?latex=i%5E%7Bth%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i^{th}' title='i^{th}' class='latex' />element in the reservoir? This is simple: we select it with probability <img src='http://s0.wp.com/latex.php?latex=k%2Fi&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/i' title='k/i' class='latex' />. But this &#8216;overflows&#8217; the reservoir, so we have to choose an element to remove to make space. All  <img src='http://s0.wp.com/latex.php?latex=i-1&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i-1' title='i-1' class='latex' />elements are in the reservoir with probability  <img src='http://s0.wp.com/latex.php?latex=k%2F%28i-1%29&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/(i-1)' title='k/(i-1)' class='latex' />by our assumption, so intuition tells us that we should just pick one of the  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />at random and evict that.

Does that work? Let&#8217;s look at the probabilities. The probability that the  <img src='http://s0.wp.com/latex.php?latex=i%5E%7Bth%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i^{th}' title='i^{th}' class='latex' />element is in the reservoir is  <img src='http://s0.wp.com/latex.php?latex=k%2Fi&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/i' title='k/i' class='latex' />which is correct. The probability that any of the  <img src='http://s0.wp.com/latex.php?latex=k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k' title='k' class='latex' />elements currently in the reservoir remain there is: <img src='http://s0.wp.com/latex.php?latex=1-%5Cfrac%7Bk%7D%7Bi%7D%2B%5Cfrac%7Bk%7D%7Bi%7D%5Cfrac%7B%28k-1%29%7D%7Bk%7D%3D%5Cfrac%7Bi-1%7D%7Bi%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='1-\frac{k}{i}+\frac{k}{i}\frac{(k-1)}{k}=\frac{i-1}{i}' title='1-\frac{k}{i}+\frac{k}{i}\frac{(k-1)}{k}=\frac{i-1}{i}' class='latex' />. For all  <img src='http://s0.wp.com/latex.php?latex=i-1&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i-1' title='i-1' class='latex' />elements already considered there is, by assumption, a  <img src='http://s0.wp.com/latex.php?latex=%5Cfrac%7Bk%7D%7Bi-1%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='\frac{k}{i-1}' title='\frac{k}{i-1}' class='latex' />probability that a given element is in the reservoir already. Multiplying the two probabilities to give the total probability that any of the  <img src='http://s0.wp.com/latex.php?latex=i-1&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i-1' title='i-1' class='latex' />elements will be in the reservoir after considering the  <img src='http://s0.wp.com/latex.php?latex=i%5E%7Bth%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i^{th}' title='i^{th}' class='latex' />element gives:


<img src='http://s0.wp.com/latex.php?latex=P%28+X_%7Bji%7D+%3D+1+%29+%3D+%5Cfrac%7Bk%7D%7Bi-1%7D%5Cfrac%7Bi-1%7D%7Bi%7D+%3D+%5Cfrac%7Bk%7D%7Bi%7D&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='P( X_{ji} = 1 ) = \frac{k}{i-1}\frac{i-1}{i} = \frac{k}{i}' title='P( X_{ji} = 1 ) = \frac{k}{i-1}\frac{i-1}{i} = \frac{k}{i}' class='latex' /> 

where  <img src='http://s0.wp.com/latex.php?latex=X_%7Bji%7D%2C+1%5Cleq+j+%3C+i&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='X_{ji}, 1\leq j < i' title='X_{ji}, 1\leq j < i' class='latex' />is a binary random variable which is 1 if element  <img src='http://s0.wp.com/latex.php?latex=j&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='j' title='j' class='latex' />is selected to be in the reservoir after considering the first  <img src='http://s0.wp.com/latex.php?latex=i&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i' title='i' class='latex' />elements.

While  <img src='http://s0.wp.com/latex.php?latex=i+%5Cle+k&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i \le k' title='i \le k' class='latex' />the probability of selecting element  <img src='http://s0.wp.com/latex.php?latex=i&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i' title='i' class='latex' />is 1 and since the reservoir will not yet be full there&#8217;s no point removing elements. This gives us the &#8216;base case&#8217; of our inductive proof: it&#8217;s easy to show that this method gives us a full reservoir with element selection probability  <img src='http://s0.wp.com/latex.php?latex=k%2Fi&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/i' title='k/i' class='latex' />when <img src='http://s0.wp.com/latex.php?latex=i%3Dk&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i=k' title='i=k' class='latex' />. For all <img src='http://s0.wp.com/latex.php?latex=i+%3Ek&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='i >k' title='i >k' class='latex' />, our inductive step above allows us to update the reservoir, keeping all the selection probabilities equal to <img src='http://s0.wp.com/latex.php?latex=k%2Fi&#038;bg=ffffff&#038;fg=000000&#038;s=0' alt='k/i' title='k/i' class='latex' />.

This is incredibly simple to implement, and very fast &#8211; because the reservoir is fixed size we can implement it as an array and not worry about high costs for insertion or deletion. Two random numbers are needed per element, making this a very efficient solution and much quicker than random access in a linearly accessible data structure.